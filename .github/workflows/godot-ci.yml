name: "godot-ci export"
on: push

# NOTE: If your `project.godot` is at the repository root, set `PROJECT_PATH` below to ".".

env:
  GODOT_VERSION: 4.5.1
  EXPORT_NAME: shader-demos
  PROJECT_PATH: .

jobs:
  # export-windows:
  #   name: Windows Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mkdir -v -p ~/.config/
  #         mv /root/.config/godot ~/.config/godot
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Windows Build
  #       run: |
  #         mkdir -v -p build/windows
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "Windows Desktop" "$EXPORT_DIR/windows/$EXPORT_NAME.exe"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: windows
  #         path: build/windows

  # export-linux:
  #   name: Linux Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Linux Build
  #       run: |
  #         mkdir -v -p build/linux
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "Linux/X11" "$EXPORT_DIR/linux/$EXPORT_NAME.x86_64"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: linux
  #         path: build/linux

  export-web:
    name: Web Export
    runs-on: ubuntu-22.04 # Use 22.04 with godot 4
    container:
      image: barichello/godot-ci:4.5.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Web Build
        run: |
          mkdir -v -p build/web
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "Web" "$EXPORT_DIR/web/index.html"

      # -----------------------------
      # üîÑ Êñ∞Â¢û: Ëá™Âä®Ê∑ªÂä† hash + Èò≤ÁºìÂ≠ò + ÁâàÊú¨Ê£ÄÊµã
      # -----------------------------
      - name: Add file hash and inject version.json üîÑ
        run: |
          cd build/web

          git config --global --add safe.directory /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          # Ëé∑ÂèñÊèê‰∫§ÂìàÂ∏å
          HASH=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Using build hash: $HASH"

          # Êñá‰ª∂ËØÜÂà´
          WASM_FILE=$(ls *.wasm)
          PCK_FILE=$(ls *.pck)
          MAIN_JS="index.js"

          WASM_NEW="${WASM_FILE%.*}.${HASH}.wasm"
          PCK_NEW="${PCK_FILE%.*}.${HASH}.pck"
          JS_NEW="${MAIN_JS%.*}.${HASH}.js"

          # ÈáçÂëΩÂêç
          mv "$WASM_FILE" "$WASM_NEW"
          mv "$PCK_FILE" "$PCK_NEW"
          mv "$MAIN_JS" "$JS_NEW"

          # Êõ¥Êñ∞ HTML
          sed -i "s|$MAIN_JS|$JS_NEW|g" index.html
          sed -i "s|$WASM_FILE|$WASM_NEW|g" index.html
          sed -i "s|$PCK_FILE|$PCK_NEW|g" index.html

          # ‚úÖ Áõ¥Êé•ÊõøÊç¢ JS ‰∏≠ÁöÑÈÖçÁΩÆ
          sed -i -E "s|(\"executable\" *: *\")index\"|\1index.${HASH}\"|g" "$JS_NEW"
          # sed -i "s|\"executable\":\"index\"|\"executable\":\"index.${HASH}\"|g" "$JS_NEW"
          sed -i "s|\"index\\.pck\"|\"index.${HASH}.pck\"|g" "$JS_NEW"
          sed -i "s|\"index\\.wasm\"|\"index.${HASH}.wasm\"|g" "$JS_NEW"

          # ‚úÖ ÂÜôÂÖ•ÁâàÊú¨Êñá‰ª∂
          cat <<EOF > version.json
          {
            "version": "${HASH}",
            "build_time": "${BUILD_DATE}",
            "branch": "${GITHUB_REF_NAME}",
            "commit_url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          }
          EOF

          # ‚úÖ Ê≥®ÂÖ•Ëá™Âä®Ê£ÄÊµãÈÄªËæë
          awk '
            /<\/body>/ && inserted==0 {
              print "<script>";
              print "async function checkVersion(){";
              print "  try {";
              print "    const res = await fetch(\"version.json?_=\"+Date.now());";
              print "    const v = await res.json();";
              print "    const local = localStorage.getItem(\"godot_build_version\");";
              print "    if(local && local !== v.version){";
              print "      console.log(`[Godot] New version detected ${v.version}, reloading...`);";
              print "      localStorage.setItem(\"godot_build_version\", v.version);";
              print "      location.reload(true);";
              print "    } else {";
              print "      localStorage.setItem(\"godot_build_version\", v.version);";
              print "    }";
              print "  } catch(e){ console.warn(\"Version check failed\", e); }";
              print "}";
              print "setInterval(checkVersion, 30000);";
              print "checkVersion();";
              print "</script>";
              inserted=1;
            }
            { print }
          ' index.html > index.tmp && mv index.tmp index.html

          # ‚úÖ Âú®Â∫ïÈÉ®ÊòæÁ§∫ÁâàÊú¨
          sed -i "s|</body>|<p style='position:fixed;bottom:4px;right:8px;font-size:12px;color:#999;'>Build ${HASH}</p></body>|" index.html

          echo "‚úî All replacements done successfully"



      # -----------------------------
      # üì¶ ‰∏ä‰º†ÊûÑÂª∫‰∫ßÁâ©
      # -----------------------------
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: build/web

      # -----------------------------
      # üöÄ ÈÉ®ÁΩ≤Âà∞ GitHub Pages
      # -----------------------------
      - name: Install rsync üìö
        run: |
          apt-get update && apt-get install -y rsync

      - name: Deploy to GitHub Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@releases/v4
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: build/web # The folder the action should deploy.
          clean: true # Ê∏ÖÁ©∫ÊóßÊñá‰ª∂ÔºåÈò≤Ê≠¢Â§öÁâàÊú¨ÊÆãÁïô


  # export-mac:
  #   name: Mac Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Mac Build
  #       run: |
  #         mkdir -v -p build/mac
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "macOS" "$EXPORT_DIR/mac/$EXPORT_NAME.zip"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: mac
  #         path: build/mac
