name: "godot-ci export"
on: push

# NOTE: If your `project.godot` is at the repository root, set `PROJECT_PATH` below to ".".
env:
  GODOT_VERSION: 4.5.1
  EXPORT_NAME: shader-demos
  PROJECT_PATH: .

jobs:
  # export-windows:
  #   name: Windows Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mkdir -v -p ~/.config/
  #         mv /root/.config/godot ~/.config/godot
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Windows Build
  #       run: |
  #         mkdir -v -p build/windows
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "Windows Desktop" "$EXPORT_DIR/windows/$EXPORT_NAME.exe"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: windows
  #         path: build/windows

  # export-linux:
  #   name: Linux Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Linux Build
  #       run: |
  #         mkdir -v -p build/linux
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "Linux/X11" "$EXPORT_DIR/linux/$EXPORT_NAME.x86_64"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: linux
  #         path: build/linux

  export-web:
    name: Web Export
    runs-on: ubuntu-22.04  # Use 22.04 with godot 4
    container:
      image: barichello/godot-ci:4.5.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Web Build
        run: |
          mkdir -v -p build/web
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "Web" "$EXPORT_DIR/web/index.html"

      # âœ… æ–°å¢ï¼šè‡ªåŠ¨ä¸º wasm/pck/js æ–‡ä»¶æ·»åŠ  hash é˜²ç¼“å­˜æœºåˆ¶
      - name: Add file hash for cache busting ğŸ”„
        run: |
          cd build/web
          # ä¿®å¤ GitHub Actions å®¹å™¨æƒé™é—®é¢˜
          git config --global --add safe.directory /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}

          # è·å–å½“å‰æäº¤çŸ­å“ˆå¸Œ
          HASH=$(git rev-parse --short HEAD)
          echo "Using build hash: $HASH"

          # è¯†åˆ«æ–‡ä»¶
          WASM_FILE=$(ls *.wasm)
          PCK_FILE=$(ls *.pck)
          JS_FILE=$(ls *.js | grep -vE "godot.*\.js")  # æ’é™¤ runtime è„šæœ¬

          # æ–°æ–‡ä»¶å
          WASM_NEW="${WASM_FILE%.*}.${HASH}.wasm"
          PCK_NEW="${PCK_FILE%.*}.${HASH}.pck"
          JS_NEW="${JS_FILE%.*}.${HASH}.js"

          # é‡å‘½åæ–‡ä»¶
          mv "$WASM_FILE" "$WASM_NEW"
          mv "$PCK_FILE" "$PCK_NEW"
          mv "$JS_FILE" "$JS_NEW"

          # æ›´æ–° index.html å¼•ç”¨
          sed -i "s|$JS_FILE|$JS_NEW|g" index.html
          sed -i "s|$WASM_FILE|$WASM_NEW|g" index.html
          sed -i "s|$PCK_FILE|$PCK_NEW|g" index.html

          # ä¿®æ”¹å¯¼å‡ºçš„ JS æ–‡ä»¶ä»¥åŠ è½½å¸¦ hash çš„èµ„æº
          sed -i "s|executable: *\"index\"|executable: \"${WASM_NEW%.*}\"|g" "$JS_NEW"
          sed -i "s|mainPack: *\"index.pck\"|mainPack: \"${PCK_NEW}\"|g" "$JS_NEW"

          # å¯é€‰ï¼šåœ¨ HTML é¡µåº•éƒ¨æ˜¾ç¤ºæ„å»ºç‰ˆæœ¬å·
          sed -i "s|</body>|<p style='position:fixed;bottom:4px;right:8px;font-size:12px;color:#999;'>Build $HASH</p></body>|" index.html
          echo "âœ” Updated index.html and $JS_NEW for hash versioning"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: build/web

      - name: Install rsync ğŸ“š
        run: |
          apt-get update && apt-get install -y rsync

      - name: Deploy to GitHub Pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@releases/v4
        with:
          branch: gh-pages               # The branch the action should deploy to.
          folder: build/web              # The folder the action should deploy.
          clean: true                    # âœ… æ¯æ¬¡éƒ¨ç½²å‰æ¸…ç©º gh-pages åˆ†æ”¯æ—§å†…å®¹

  # export-mac:
  #   name: Mac Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Mac Build
  #       run: |
  #         mkdir -v -p build/mac
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "macOS" "$EXPORT_DIR/mac/$EXPORT_NAME.zip"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: mac
  #         path: build/mac
