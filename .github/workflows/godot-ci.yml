name: "godot-ci export"
on: push

# NOTE: If your `project.godot` is at the repository root, set `PROJECT_PATH` below to ".".

env:
  GODOT_VERSION: 4.5.1
  EXPORT_NAME: shader-demos
  PROJECT_PATH: .

jobs:
  # export-windows:
  #   name: Windows Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mkdir -v -p ~/.config/
  #         mv /root/.config/godot ~/.config/godot
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Windows Build
  #       run: |
  #         mkdir -v -p build/windows
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "Windows Desktop" "$EXPORT_DIR/windows/$EXPORT_NAME.exe"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: windows
  #         path: build/windows

  # export-linux:
  #   name: Linux Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Linux Build
  #       run: |
  #         mkdir -v -p build/linux
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "Linux/X11" "$EXPORT_DIR/linux/$EXPORT_NAME.x86_64"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: linux
  #         path: build/linux

  export-web:
    name: Web Export
    runs-on: ubuntu-22.04 # Use 22.04 with godot 4
    container:
      image: barichello/godot-ci:4.5.1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup
        run: |
          mkdir -v -p ~/.local/share/godot/export_templates/
          mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable

      - name: Web Build
        run: |
          mkdir -v -p build/web
          EXPORT_DIR="$(readlink -f build)"
          cd $PROJECT_PATH
          godot --headless --verbose --export-release "Web" "$EXPORT_DIR/web/index.html"

      # -----------------------------
      # ğŸ”„ æ–°å¢: è‡ªåŠ¨æ·»åŠ  hash + é˜²ç¼“å­˜ + ç‰ˆæœ¬æ£€æµ‹
      # -----------------------------
      - name: Add file hash and inject version.json ğŸ”„
        run: |
          cd build/web

          git config --global --add safe.directory /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}
          # è·å–æäº¤å“ˆå¸Œ
          HASH=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Using build hash: $HASH"

          # æ–‡ä»¶è¯†åˆ«
          WASM_FILE=$(ls *.wasm)
          PCK_FILE=$(ls *.pck)
          MAIN_JS="index.js"

          # -----------------------------
          # ğŸ§© æ–°é€»è¾‘: æ”¯æŒæ‰€æœ‰ js æ–‡ä»¶å¹¶æ­£ç¡®æ’å…¥ hash åˆ° index.å
          # -----------------------------
          insert_hash_after_first_dot() {
            local f="$1"
            local base="${f%%.*}"
            local rest="${f#*.}"
            echo "${base}.${HASH}.${rest}"
          }

          # æ‰€æœ‰ JS æ–‡ä»¶
          JS_FILES=$(ls *.js)

          # ç”Ÿæˆæ–°æ–‡ä»¶å
          WASM_NEW=$(insert_hash_after_first_dot "$WASM_FILE")
          PCK_NEW=$(insert_hash_after_first_dot "$PCK_FILE")

          # é‡å‘½å wasm / pck
          mv "$WASM_FILE" "$WASM_NEW"
          mv "$PCK_FILE" "$PCK_NEW"

          # æ›¿æ¢ HTML ä¸­ wasm / pck å¼•ç”¨
          sed -i "s|$WASM_FILE|$WASM_NEW|g" index.html
          sed -i "s|$PCK_FILE|$PCK_NEW|g" index.html
          sed -i "s|\"executable\":\"index\"|\"executable\":\"index.${HASH}\"|g" index.html

          # -----------------------------
          # ğŸ” éå†æ‰€æœ‰ JS æ–‡ä»¶å¹¶æ”¹åä¸º index.<hash>.xxx.js
          # -----------------------------
          for JS in $JS_FILES; do
            JS_NEW=$(insert_hash_after_first_dot "$JS")
            mv "$JS" "$JS_NEW"

            # æ›´æ–° HTML å¼•ç”¨
            sed -i "s|$JS|$JS_NEW|g" index.html

            # æ›´æ–°å…¶ä»– JS å†…éƒ¨å¼•ç”¨ï¼ˆimportScripts / worklet / etcï¼‰
            for OTHER_JS in $(ls *.js); do
              sed -i "s|$JS|$JS_NEW|g" "$OTHER_JS"
            done
          done

          # âœ… å†™å…¥ç‰ˆæœ¬æ–‡ä»¶
          cat <<EOF > version.json
          {
            "version": "${HASH}",
            "build_time": "${BUILD_DATE}",
            "branch": "${GITHUB_REF_NAME}",
            "commit_url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          }
          EOF

          # âœ… æ³¨å…¥è‡ªåŠ¨æ£€æµ‹é€»è¾‘
          awk '
            /<\/body>/ && inserted==0 {
              print "<script>";
              print "async function checkVersion(){";
              print "  try {";
              print "    const res = await fetch(\"version.json?_=\"+Date.now());";
              print "    const v = await res.json();";
              print "    const local = localStorage.getItem(\"godot_build_version\");";
              print "    if(local && local !== v.version){";
              print "      console.log(`[Godot] New version detected ${v.version}, reloading...`);";
              print "      localStorage.setItem(\"godot_build_version\", v.version);";
              print "      location.reload(true);";
              print "    } else {";
              print "      localStorage.setItem(\"godot_build_version\", v.version);";
              print "    }";
              print "  } catch(e){ console.warn(\"Version check failed\", e); }";
              print "}";
              print "setInterval(checkVersion, 30000);";
              print "checkVersion();";
              print "</script>";
              inserted=1;
            }
            { print }
          ' index.html > index.tmp && mv index.tmp index.html

          # âœ… åœ¨åº•éƒ¨æ˜¾ç¤ºç‰ˆæœ¬
          sed -i "s|</body>|<p style='position:fixed;bottom:4px;right:8px;font-size:12px;color:#999;'>Build ${HASH}</p></body>|" index.html

          echo "âœ” All replacements done successfully"

      # -----------------------------
      # ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
      # -----------------------------
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: build/web

      # -----------------------------
      # ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
      # -----------------------------
      - name: Install rsync ğŸ“š
        run: |
          apt-get update && apt-get install -y rsync

      - name: Deploy to GitHub Pages ğŸš€
        uses: JamesIves/github-pages-deploy-action@releases/v4
        with:
          branch: gh-pages # The branch the action should deploy to.
          folder: build/web # The folder the action should deploy.
          clean: true # æ¸…ç©ºæ—§æ–‡ä»¶ï¼Œé˜²æ­¢å¤šç‰ˆæœ¬æ®‹ç•™


  # export-mac:
  #   name: Mac Export
  #   runs-on: ubuntu-22.04  # Use 22.04 with godot 4
  #   container:
  #     image: barichello/godot-ci:4.4.1
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Setup
  #       run: |
  #         mkdir -v -p ~/.local/share/godot/export_templates/
  #         mv /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable ~/.local/share/godot/export_templates/${GODOT_VERSION}.stable
  #     - name: Mac Build
  #       run: |
  #         mkdir -v -p build/mac
  #         EXPORT_DIR="$(readlink -f build)"
  #         cd $PROJECT_PATH
  #         godot --headless --verbose --export-release "macOS" "$EXPORT_DIR/mac/$EXPORT_NAME.zip"
  #     - name: Upload Artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: mac
  #         path: build/mac
